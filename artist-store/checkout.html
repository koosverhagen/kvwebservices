<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Checkout | Abbie at Heart</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header">
    <div class="container header-inner">
      <a class="logo" href="index.html">
        <img class="logo-mark" src="../images/abbie/abbie-art-logo.webp" alt="Abbie at Heart logo">
        <span>Abbie at Heart</span>
      </a>
      <div class="header-links">
        <a href="../index.html" class="kv-home-link">← KV Web Services</a>
        <a class="btn ghost" href="https://galleries.artprinthub.com/abbhart">Buy Art</a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="section panel" style="padding: 24px; margin-top: 30px;">
      <h2>Checkout Details</h2>
      <p>Enter customer details and continue to secure Stripe payment.</p>

      <form id="checkout-form" class="form-grid">
        <input required name="name" placeholder="Full name">
        <input required type="email" name="email" placeholder="Email address">
        <input class="full" required name="address" id="shipping-address" list="address-suggestions" autocomplete="street-address" placeholder="Shipping address">
        <datalist id="address-suggestions"></datalist>
        <textarea class="full" name="notes" rows="4" placeholder="Order notes (optional)"></textarea>
        <button class="btn full" type="submit">Continue to Stripe</button>
      </form>

      <div class="note">Address suggestions appear while typing. Best results: start with house number/name + street or postcode.</div>

      <div class="panel" style="margin-top: 18px; padding: 16px;">
        <strong>Order Summary</strong>
        <div id="order-summary" class="muted" style="margin-top:8px;"></div>
      </div>

      <div class="note">For multi-item carts with automated totals at payment, migrate to custom Stripe Checkout later. This phase uses a Payment Link flow.</div>
    </section>
  </main>

  <script>
    const payload = JSON.parse(localStorage.getItem("kv_artist_checkout") || "null");
    const summary = document.getElementById("order-summary");
    const form = document.getElementById("checkout-form");
    const addressInput = document.getElementById("shipping-address");
    const addressSuggestions = document.getElementById("address-suggestions");
    let searchTimeout = null;
    let activeRequest = null;

    function buildPhotonLabel(properties) {
      const firstLine = [properties.housenumber, properties.street].filter(Boolean).join(" ").trim();
      const parts = [
        firstLine,
        properties.city || properties.town || properties.county || properties.state,
        properties.postcode,
        properties.country
      ].filter(Boolean);

      return parts.join(", ");
    }

    function normalizeAddressText(value) {
      return String(value || "").replace(/\s+/g, " ").trim();
    }

    async function lookupAddress(query) {
      if (activeRequest) activeRequest.abort();
      activeRequest = new AbortController();

      const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=6&countrycodes=gb&q=${encodeURIComponent(query)}`;
      const photonUrl = `https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=6&lang=en`;

      const [nominatimResponse, photonResponse] = await Promise.allSettled([
        fetch(nominatimUrl, {
          signal: activeRequest.signal,
          headers: {
            "Accept-Language": "en-GB"
          }
        }),
        fetch(photonUrl, {
          signal: activeRequest.signal,
          headers: {
            "Accept-Language": "en-GB"
          }
        })
      ]);

      const options = [];

      if (nominatimResponse.status === "fulfilled" && nominatimResponse.value.ok) {
        const nominatimJson = await nominatimResponse.value.json();
        if (Array.isArray(nominatimJson)) {
          nominatimJson.forEach((item) => {
            if (item?.display_name) options.push(normalizeAddressText(item.display_name));
          });
        }
      }

      if (photonResponse.status === "fulfilled" && photonResponse.value.ok) {
        const photonJson = await photonResponse.value.json();
        const features = Array.isArray(photonJson?.features) ? photonJson.features : [];
        features.forEach((feature) => {
          const label = buildPhotonLabel(feature?.properties || {});
          if (label) options.push(normalizeAddressText(label));
        });
      }

      const unique = [];
      const seen = new Set();
      options.forEach((label) => {
        const key = label.toLowerCase();
        if (!seen.has(key)) {
          seen.add(key);
          unique.push(label);
        }
      });

      return unique.slice(0, 8);
    }

    function renderAddressSuggestions(results) {
      addressSuggestions.innerHTML = "";
      results.forEach((item) => {
        const option = document.createElement("option");
        option.value = item;
        addressSuggestions.appendChild(option);
      });
    }

    function wireAddressAutocomplete() {
      if (!addressInput || !addressSuggestions) return;

      addressInput.addEventListener("input", () => {
        const query = addressInput.value.trim();

        if (searchTimeout) clearTimeout(searchTimeout);
        if (query.length < 5) {
          addressSuggestions.innerHTML = "";
          return;
        }

        searchTimeout = setTimeout(async () => {
          try {
            const results = await lookupAddress(query);
            renderAddressSuggestions(results);
          } catch (error) {
            if (error.name !== "AbortError") {
              addressSuggestions.innerHTML = "";
            }
          }
        }, 260);
      });
    }

    wireAddressAutocomplete();

    if (!payload || !payload.items || !payload.items.length) {
      summary.textContent = "No checkout data found. Return to store and add items.";
      form.style.display = "none";
    } else {
      const subtotal = payload.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
      const promo = (payload.promoCode || "").trim().toUpperCase();
      const promoPct = payload.settings.promoCodes[promo] || 0;
      const discount = subtotal * (promoPct / 100);
      const total = Math.max(0, subtotal - discount + payload.shippingCost);

      summary.innerHTML = payload.items
        .map((item) => `${item.title} × ${item.quantity} — £${(item.quantity * item.price).toFixed(2)}`)
        .join("<br>") + `<br><br>Subtotal: £${subtotal.toFixed(2)}<br>Discount: -£${discount.toFixed(2)}<br>Shipping: £${payload.shippingCost.toFixed(2)}<br><strong>Total: £${total.toFixed(2)}</strong>`;

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const data = new FormData(form);
        const customer = {
          name: data.get("name"),
          email: data.get("email"),
          address: data.get("address"),
          notes: data.get("notes")
        };

        localStorage.setItem("kv_artist_last_order", JSON.stringify({ ...payload, customer, total }));
        window.location.href = payload.settings.stripePaymentLink;
      });
    }
  </script>
</body>
</html>
